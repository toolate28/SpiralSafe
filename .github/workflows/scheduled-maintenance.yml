name: Scheduled Maintenance

on:
  schedule:
    # Run daily at 02:00 UTC
    - cron: '0 2 * * *'
  workflow_dispatch:  # Allow manual triggering

jobs:
  update-freshness:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup environment
        run: |
          chmod +x scripts/*.sh
          mkdir -p .atom-trail/decisions
          mkdir -p .atom-trail/bedrock
          mkdir -p .claude/logs
      
      - name: Update ATOM freshness levels
        id: freshness
        run: |
          ./scripts/update-freshness.sh > freshness-report.txt 2>&1
          cat freshness-report.txt
          
          # Extract metrics for summary
          FRESH=$(grep "^Fresh:" freshness-report.txt | awk '{print $2}' || echo "0")
          AGING=$(grep "^Aging:" freshness-report.txt | awk '{print $2}' || echo "0")
          SETTLED=$(grep "^Settled:" freshness-report.txt | awk '{print $2}' || echo "0")
          BEDROCK=$(grep "^Bedrock:" freshness-report.txt | awk '{print $2}' || echo "0")
          
          echo "fresh=${FRESH}" >> $GITHUB_OUTPUT
          echo "aging=${AGING}" >> $GITHUB_OUTPUT
          echo "settled=${SETTLED}" >> $GITHUB_OUTPUT
          echo "bedrock=${BEDROCK}" >> $GITHUB_OUTPUT
      
      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet .atom-trail/; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No freshness changes detected"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Freshness changes detected"
          fi
      
      - name: Create PR for freshness updates
        if: steps.changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "ATOM: Scheduled freshness update - $(date +%Y-%m-%d)"
          title: "ðŸ”„ Scheduled ATOM Freshness Update"
          body: |
            ## Automated ATOM Freshness Update
            
            This PR updates the freshness levels of ATOM decisions based on their age.
            
            ### Freshness Summary
            - **Fresh:** ${{ steps.freshness.outputs.fresh }}
            - **Aging:** ${{ steps.freshness.outputs.aging }}
            - **Settled:** ${{ steps.freshness.outputs.settled }}
            - **Bedrock:** ${{ steps.freshness.outputs.bedrock }}
            
            ### Lifecycle
            - **Fresh** (0-30 days): Active decisions
            - **Aging** (30-90 days): Maturing decisions
            - **Settled** (90-180 days): Stable decisions
            - **Bedrock** (180+ days): Archived to bedrock
            
            This is an automated update generated by the scheduled maintenance workflow.
            
            **ATOM:** ATOM-AUTO-$(date +%Y%m%d)-FRESHNESS-UPDATE
          branch: automation/freshness-update-$(date +%Y%m%d)
          labels: automated, atom-maintenance
          delete-branch: true
      
      - name: Archive freshness report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: freshness-report-$(date +%Y%m%d)
          path: freshness-report.txt
          retention-days: 90
  
  cleanup-stale-branches:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Find stale branches
        id: stale
        run: |
          echo "Finding branches older than 90 days..."
          
          # Get all remote branches
          git fetch --all
          
          # Find stale branches (not main, develop, or active PR branches)
          STALE_BRANCHES=""
          CUTOFF_DATE=$(date -d '90 days ago' +%s)
          
          for branch in $(git branch -r | grep -v HEAD | grep -v main | grep -v develop | sed 's/origin\///'); do
            LAST_COMMIT=$(git log -1 --format=%ct "origin/$branch" 2>/dev/null || echo "0")
            
            if [ "$LAST_COMMIT" -lt "$CUTOFF_DATE" ]; then
              # Check if branch has open PR
              if ! gh pr list --head "$branch" --state open --json number --jq '.[].number' >/dev/null 2>&1; then
                STALE_BRANCHES="$STALE_BRANCHES $branch"
              fi
            fi
          done
          
          if [ -n "$STALE_BRANCHES" ]; then
            echo "stale_branches<<EOF" >> $GITHUB_OUTPUT
            echo "$STALE_BRANCHES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "has_stale=true" >> $GITHUB_OUTPUT
          else
            echo "has_stale=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Report stale branches
        if: steps.stale.outputs.has_stale == 'true'
        run: |
          echo "âš ï¸ Found stale branches (>90 days, no open PR):"
          echo "${{ steps.stale.outputs.stale_branches }}"
          echo ""
          echo "To clean up manually:"
          echo "git push origin --delete <branch-name>"
