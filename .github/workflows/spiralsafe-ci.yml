# ═══════════════════════════════════════════════════════════════
# SpiralSafe CI/CD Pipeline
# Coherence-verified continuous integration
# ═══════════════════════════════════════════════════════════════
#
# This workflow implements Day Zero Design principles:
# - Coherence checks before merge (wave.md)
# - Permission verification (AWI)
# - Atomic task tracking (ATOM)
# - Structured handoffs (bump.md)
#
# H&&S: Structure-preserving operations across substrates

name: SpiralSafe CI

# Security: Minimal permissions (CodeQL fix)
permissions:
  contents: read
  
on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      skip_coherence:
        description: 'Skip coherence checks'
        type: boolean
        default: false

env:
  SPIRALSAFE_API_BASE: ${{ vars.SPIRALSAFE_API_BASE || 'https://api.spiralsafe.org' }}
  NODE_VERSION: '20'

jobs:
  # ─────────────────────────────────────────────────────────────
  # Phase 1: Coherence Analysis (wave.md)
  # ─────────────────────────────────────────────────────────────
  coherence:
    name: Wave Coherence Check
    runs-on: ubuntu-latest
    if: ${{ !inputs.skip_coherence }}
    permissions:
      contents: read
    
    outputs:
      coherent: ${{ steps.analyze.outputs.coherent }}
      curl: ${{ steps.analyze.outputs.curl }}
      divergence: ${{ steps.analyze.outputs.divergence }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Analyze Documentation Coherence
        id: analyze
        run: |
          echo "═══════════════════════════════════════════════════════════════"
          echo "  SpiralSafe Wave Analysis"
          echo "═══════════════════════════════════════════════════════════════"
          
          # Find all markdown files
          FILES=$(find . -name "*.md" -not -path "./node_modules/*" -not -path "./.git/*")
          
          TOTAL_CURL=0
          TOTAL_DIV=0
          COUNT=0
          FAILED=()
          
          for file in $FILES; do
            # Local coherence analysis (simplified)
            CONTENT=$(cat "$file")
            
            # Count repeated phrases (proxy for curl)
            PHRASES=$(echo "$CONTENT" | tr '.' '\n' | sort | uniq -d | wc -l)
            TOTAL_PHRASES=$(echo "$CONTENT" | tr '.' '\n' | wc -l)
            
            if [ "$TOTAL_PHRASES" -gt 0 ]; then
              CURL=$(echo "scale=2; $PHRASES / $TOTAL_PHRASES" | bc)
            else
              CURL=0
            fi
            
            # Count unresolved questions (proxy for divergence)
            QUESTIONS=$(echo "$CONTENT" | grep -c '?' || true)
            HAS_CONCLUSION=$(echo "$CONTENT" | grep -cE 'therefore|thus|conclusion|summary' || true)
            
            if [ "$HAS_CONCLUSION" -gt 0 ]; then
              DIV="0.20"
            else
              DIV=$(echo "scale=2; 0.3 + ($QUESTIONS * 0.05)" | bc)
            fi
            
            # Check thresholds
            CURL_FAIL=$(echo "$CURL > 0.6" | bc)
            DIV_FAIL=$(echo "$DIV > 0.7" | bc)
            
            if [ "$CURL_FAIL" -eq 1 ] || [ "$DIV_FAIL" -eq 1 ]; then
              FAILED+=("$file")
              echo "⚠ $file - curl:$CURL div:$DIV"
            else
              echo "✓ $file - curl:$CURL div:$DIV"
            fi
            
            TOTAL_CURL=$(echo "$TOTAL_CURL + $CURL" | bc)
            TOTAL_DIV=$(echo "$TOTAL_DIV + $DIV" | bc)
            COUNT=$((COUNT + 1))
          done
          
          # Calculate averages
          if [ "$COUNT" -gt 0 ]; then
            AVG_CURL=$(echo "scale=2; $TOTAL_CURL / $COUNT" | bc)
            AVG_DIV=$(echo "scale=2; $TOTAL_DIV / $COUNT" | bc)
          else
            AVG_CURL=0
            AVG_DIV=0
          fi
          
          echo ""
          echo "───────────────────────────────────────────────────────────────"
          echo "  Summary: $COUNT files analyzed"
          echo "  Average Curl: $AVG_CURL"
          echo "  Average Divergence: $AVG_DIV"
          echo "───────────────────────────────────────────────────────────────"
          
          # Set outputs
          if [ ${#FAILED[@]} -eq 0 ]; then
            echo "coherent=true" >> $GITHUB_OUTPUT
            echo ""
            echo "✓ All files pass coherence checks"
          else
            echo "coherent=false" >> $GITHUB_OUTPUT
            echo ""
            echo "⚠ ${#FAILED[@]} file(s) failed coherence checks:"
            printf '  - %s\n' "${FAILED[@]}"
          fi
          
          echo "curl=$AVG_CURL" >> $GITHUB_OUTPUT
          echo "divergence=$AVG_DIV" >> $GITHUB_OUTPUT
      
      - name: Report to API
        if: always()
        continue-on-error: true
        run: |
          curl -X POST "${{ env.SPIRALSAFE_API_BASE }}/api/wave/analyze" \
            -H "Content-Type: application/json" \
            -d '{
              "content": "CI coherence check",
              "metadata": {
                "repository": "${{ github.repository }}",
                "sha": "${{ github.sha }}",
                "curl": ${{ steps.analyze.outputs.curl || 0 }},
                "divergence": ${{ steps.analyze.outputs.divergence || 0 }}
              }
            }' || true

  # ─────────────────────────────────────────────────────────────
  # Lint: Static Analysis (ShellCheck + PSScriptAnalyzer)
  # ─────────────────────────────────────────────────────────────
  lint:
    name: Lint & Static Analysis
    runs-on: ubuntu-latest
    needs: [coherence]
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install ShellCheck
        run: |
          sudo apt-get update && sudo apt-get install -y shellcheck || true

      - name: Run ShellCheck on scripts
        run: |
          set -e
          SCRIPTS=$(find . -type f -name "*.sh" -not -path './node_modules/*' -not -path './.git/*')
          if [ -n "$SCRIPTS" ]; then
            shellcheck -x $SCRIPTS || true
          else
            echo "No shell scripts found"
          fi

      - name: Setup PowerShell
        uses: PowerShell/Setup-PowerShell@v2
        with:
          pwsh-version: '7.3.8'

      - name: Install PSScriptAnalyzer
        run: |
          pwsh -Command "Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser"

      - name: Run PSScriptAnalyzer
        run: |
          pwsh -Command "Get-ChildItem -Path . -Recurse -Include *.ps1 | ForEach-Object { Invoke-ScriptAnalyzer -Path $_.FullName -Severity Warning,Error }"

  # ─────────────────────────────────────────────────────────────
  # Phase 2: Build & Test
  # ─────────────────────────────────────────────────────────────
  build:
    name: Build & Test
    runs-on: ubuntu-latest
    needs: [coherence, lint]
    if: always() && (needs.coherence.result == 'success' || needs.coherence.result == 'skipped')
    permissions:
      contents: read
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install Dependencies
        run: npm ci
      
      - name: Type Check
        run: npm run typecheck || true
      
      - name: Lint
        run: npm run lint || true
      
      - name: Test
        run: npm test || true
      
      - name: Build
        run: npm run build

  # ─────────────────────────────────────────────────────────────
  # Phase 3: Deploy (Production)
  # ─────────────────────────────────────────────────────────────
  deploy:
    name: Deploy to Cloudflare
    runs-on: ubuntu-latest
    needs: [coherence, build]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production
    permissions:
      contents: read
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install Dependencies
        run: npm ci
      
      - name: Build
        run: npm run build
      
      - name: Create AWI Grant
        id: awi
        continue-on-error: true
        run: |
          RESPONSE=$(curl -s -X POST "${{ env.SPIRALSAFE_API_BASE }}/api/awi/request" \
            -H "Content-Type: application/json" \
            -d '{
              "intent": "CI/CD deployment to production",
              "scope": {
                "resources": ["worker:spiralsafe-api"],
                "actions": ["deploy"]
              },
              "level": 3,
              "ttl_seconds": 600
            }')
          
          GRANT_ID=$(echo "$RESPONSE" | jq -r '.id // empty')
          if [ -n "$GRANT_ID" ]; then
            echo "grant_id=$GRANT_ID" >> $GITHUB_OUTPUT
            echo "✓ AWI grant created: $GRANT_ID"
          else
            echo "⚠ AWI grant creation skipped (API unavailable)"
          fi
      
      - name: Deploy Worker
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: deploy
      
      - name: Create Bump Marker
        if: success()
        continue-on-error: true
        run: |
          curl -s -X POST "${{ env.SPIRALSAFE_API_BASE }}/api/bump/create" \
            -H "Content-Type: application/json" \
            -d '{
              "type": "SYNC",
              "from": "github-actions",
              "to": "production",
              "state": "deployed",
              "context": {
                "sha": "${{ github.sha }}",
                "run_id": "${{ github.run_id }}",
                "awi_grant": "${{ steps.awi.outputs.grant_id }}"
              }
            }' || true
          
          echo ""
          echo "H&&S:SYNC → Deployment complete"

  # ─────────────────────────────────────────────────────────────
  # Phase 4: Post-Deploy Verification
  # ─────────────────────────────────────────────────────────────
  verify:
    name: Verify Deployment
    runs-on: ubuntu-latest
    needs: [deploy]
    if: success()
    permissions:
      contents: read
    
    steps:
      - name: Health Check
        run: |
          echo "Waiting for deployment propagation..."
          sleep 10
          
          RESPONSE=$(curl -s "${{ env.SPIRALSAFE_API_BASE }}/api/health")
          STATUS=$(echo "$RESPONSE" | jq -r '.status')
          
          if [ "$STATUS" == "healthy" ]; then
            echo "✓ API is healthy"
            echo "$RESPONSE" | jq .
          else
            echo "⚠ API health check failed"
            echo "$RESPONSE" | jq .
            exit 1
          fi
      
      - name: Resolve Deployment Bump
        continue-on-error: true
        run: |
          # Get the most recent deployment bump
          BUMPS=$(curl -s "${{ env.SPIRALSAFE_API_BASE }}/api/bump/pending")
          BUMP_ID=$(echo "$BUMPS" | jq -r '.[0].id // empty')
          
          if [ -n "$BUMP_ID" ]; then
            curl -s -X PUT "${{ env.SPIRALSAFE_API_BASE }}/api/bump/resolve/$BUMP_ID"
            echo "✓ Deployment bump resolved"
          fi

  # ─────────────────────────────────────────────────────────────
  # Notify on Failure
  # ─────────────────────────────────────────────────────────────
  notify-failure:
    name: Notify Failure
    runs-on: ubuntu-latest
    needs: [coherence, build, deploy]
    if: failure()
    permissions:
      contents: read
    
    steps:
      - name: Create BLOCK Bump
        continue-on-error: true
        run: |
          curl -s -X POST "${{ env.SPIRALSAFE_API_BASE }}/api/bump/create" \
            -H "Content-Type: application/json" \
            -d '{
              "type": "BLOCK",
              "from": "github-actions",
              "to": "human",
              "state": "pipeline-failure",
              "context": {
                "repository": "${{ github.repository }}",
                "sha": "${{ github.sha }}",
                "run_url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
              }
            }' || true
          
          echo ""
          echo "H&&S:BLOCK → Pipeline failure requires attention"
