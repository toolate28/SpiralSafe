name: Auto-Generate ATOM Tags

on:
  issues:
    types: [opened]
  pull_request:
    types: [opened]

jobs:
  generate-atom-tag:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: write
      contents: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup environment
        run: |
          chmod +x scripts/*.sh
          mkdir -p .atom-trail/decisions
          mkdir -p .claude/logs
      
      - name: Determine type and generate ATOM tag
        id: atom
        run: |
          # Determine type based on labels or title
          if [ "${{ github.event_name }}" = "issues" ]; then
            TITLE="${{ github.event.issue.title }}"
            NUMBER="${{ github.event.issue.number }}"
            LABELS="${{ join(github.event.issue.labels.*.name, ',') }}"
            
            # Determine type from labels or title
            if echo "$LABELS" | grep -qi "bug"; then
              TYPE="BUG"
            elif echo "$LABELS" | grep -qi "enhancement\|feature"; then
              TYPE="FEATURE"
            elif echo "$LABELS" | grep -qi "documentation"; then
              TYPE="DOC"
            elif echo "$LABELS" | grep -qi "task\|chore"; then
              TYPE="TASK"
            elif echo "$TITLE" | grep -qi "\[BUG\]"; then
              TYPE="BUG"
            elif echo "$TITLE" | grep -qi "\[FEATURE\]"; then
              TYPE="FEATURE"
            elif echo "$TITLE" | grep -qi "\[DOCS\]"; then
              TYPE="DOC"
            elif echo "$TITLE" | grep -qi "\[TASK\]"; then
              TYPE="TASK"
            else
              TYPE="ISSUE"
            fi
            
            ITEM_TYPE="issue"
          else
            TITLE="${{ github.event.pull_request.title }}"
            NUMBER="${{ github.event.pull_request.number }}"
            TYPE="PR"
            ITEM_TYPE="pull_request"
          fi
          
          # Clean title for ATOM tag
          CLEAN_TITLE=$(echo "$TITLE" | sed -E 's/^\[.*\]//g' | tr '[:upper:]' '[:lower:]' | sed -E 's/[^a-z0-9]+/-/g' | sed -E 's/^-+|-+$//g' | cut -c1-60)
          
          # Generate ATOM tag
          ATOM_TAG=$(./scripts/atom-track.sh "$TYPE" "$CLEAN_TITLE" "$ITEM_TYPE-$NUMBER")
          
          echo "atom_tag=${ATOM_TAG}" >> $GITHUB_OUTPUT
          echo "item_type=${ITEM_TYPE}" >> $GITHUB_OUTPUT
          echo "number=${NUMBER}" >> $GITHUB_OUTPUT
      
      - name: Create comment with ATOM tag
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const atomTag = '${{ steps.atom.outputs.atom_tag }}';
            const itemType = '${{ steps.atom.outputs.item_type }}';
            const number = parseInt('${{ steps.atom.outputs.number }}');
            
            const comment = `## üè∑Ô∏è ATOM Tag Auto-Generated
            
            **ATOM Tag:** \`${atomTag}\`
            
            This tag has been automatically generated and logged to the ATOM trail.
            
            ### Usage in commits:
            \`\`\`bash
            git commit -m "${atomTag}: Your commit message"
            \`\`\`
            
            ### View decision history:
            \`\`\`bash
            cat .atom-trail/decisions/${atomTag}.json
            \`\`\`
            
            ### Framework Alignment Checklist:
            - [ ] **Visible State** - Changes are observable and logged
            - [ ] **Clear Intent** - Purpose and reasoning documented
            - [ ] **Natural Decomposition** - Work breaks at logical boundaries
            - [ ] **Networked Learning** - Knowledge transfers to others
            - [ ] **Measurable Delivery** - Success criteria defined
            
            ---
            *ATOM tag generated by Safe Spiral automation*`;
            
            if (itemType === 'issue') {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: number,
                body: comment
              });
              
              // Add label
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: number,
                labels: ['atom-tagged']
              });
              
              // Remove needs-atom-tag label if present
              try {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: number,
                  name: 'needs-atom-tag'
                });
              } catch (e) {
                // Label might not exist, that's okay
              }
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: number,
                body: comment
              });
              
              // Add label to PR
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: number,
                labels: ['atom-tagged']
              });
            }
      
      - name: Commit ATOM trail to branch (for PRs)
        if: github.event_name == 'pull_request'
        run: |
          git config user.name "ATOM Bot"
          git config user.email "atom-bot@safespiral.org"
          
          git add .atom-trail/
          git add .claude/logs/
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ATOM: ${{ steps.atom.outputs.atom_tag }} - Auto-generated trail"
            
            # Note: This requires a PAT with write permissions
            # For now, just report the tag without pushing
            echo "ATOM trail would be committed (requires write permissions)"
          fi
      
      - name: Archive ATOM trail
        uses: actions/upload-artifact@v4
        with:
          name: atom-trail-${{ steps.atom.outputs.atom_tag }}
          path: |
            .atom-trail/decisions/${{ steps.atom.outputs.atom_tag }}.json
            .claude/logs/atom-trail.jsonl
          retention-days: 90
