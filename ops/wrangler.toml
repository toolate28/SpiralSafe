# ═══════════════════════════════════════════════════════════════
# SpiralSafe Operations API
# Cloudflare Worker Configuration
# ═══════════════════════════════════════════════════════════════

name = "spiralsafe-api"
main = "api/spiralsafe-worker.ts"
compatibility_date = "2024-01-01"
compatibility_flags = ["nodejs_compat"]
# account_id set via CLOUDFLARE_ACCOUNT_ID env var

# Production route
routes = [
  { pattern = "api.spiralsafe.org/*", zone_name = "spiralsafe.org" }
]

# Development
[env.dev]
name = "spiralsafe-api-dev"
routes = [
  { pattern = "api-dev.spiralsafe.org/*", zone_name = "spiralsafe.org" }
]

# ═══════════════════════════════════════════════════════════════
# D1 Database Bindings
# ═══════════════════════════════════════════════════════════════

[[d1_databases]]
binding = "SPIRALSAFE_DB"
database_name = "spiralsafe-ops"
database_id = "d47d04ca-7d74-41a8-b489-0af373a2bb2c"

[env.dev.d1_databases]
binding = "SPIRALSAFE_DB"
database_name = "spiralsafe-ops-dev"
database_id = ""  # Fill after: wrangler d1 create spiralsafe-ops-dev

# ═══════════════════════════════════════════════════════════════
# KV Namespace Bindings
# ═══════════════════════════════════════════════════════════════

[[kv_namespaces]]
binding = "SPIRALSAFE_KV"
id = "79d496efbfab4d54a6277ed80dc29d1f"

[env.dev.kv_namespaces]
binding = "SPIRALSAFE_KV"
id = ""  # Fill after: wrangler kv:namespace create SPIRALSAFE_KV --preview

# ═══════════════════════════════════════════════════════════════
# R2 Bucket Bindings
# ═══════════════════════════════════════════════════════════════

[[r2_buckets]]
binding = "SPIRALSAFE_R2"
bucket_name = "spiralsafe-contexts"

[env.dev.r2_buckets]
binding = "SPIRALSAFE_R2"
bucket_name = "spiralsafe-contexts-dev"

# ═══════════════════════════════════════════════════════════════
# Build Configuration
# ═══════════════════════════════════════════════════════════════

[build]
command = "npm run build"

# Note: build.upload removed - wrangler 3.x infers format automatically

# ═══════════════════════════════════════════════════════════════
# Observability
# ═══════════════════════════════════════════════════════════════

[observability]
enabled = true
